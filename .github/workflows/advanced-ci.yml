name: ğŸš€ Advanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BACKEND_IMAGE: user-management-backend
  FRONTEND_IMAGE: user-management-frontend

jobs:
  # ==================== BUILD INFO ====================
  build-info:
    name: ğŸ“‹ Build Information
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Display Build Info
        run: |
          echo "ğŸš€ ========================================"
          echo "     CI/CD PIPELINE STARTED"
          echo "=========================================="
          echo ""
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "ğŸ• Time: $(date)"
          echo ""
          echo "=========================================="

  # ==================== BACKEND ====================
  test-backend:
    name: ğŸ”¨ Backend - Build & Test
    runs-on: ubuntu-latest
    needs: build-info
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ğŸ” Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: ğŸ”¨ Build Backend
        run: |
          cd backend
          echo "ğŸ”¨ Building backend..."
          mvn clean package -DskipTests
          echo "âœ… Build completed!"
      
      - name: ğŸ§ª Run Unit Tests
        run: |
          cd backend
          echo "ğŸ§ª Running unit tests..."
          mvn test
          echo "âœ… Tests completed!"
      
      - name: ğŸ“Š Generate Test Coverage Report
        run: |
          cd backend
          echo "ğŸ“Š Generating coverage report..."
          mvn jacoco:report
          echo "âœ… Coverage report generated!"
      
      - name: ğŸ“ˆ Display Coverage Summary
        run: |
          cd backend
          echo "ğŸ“ˆ Test Coverage Summary:"
          echo "=========================="
          if [ -f target/site/jacoco/index.html ]; then
            echo "âœ… Coverage report available"
            echo "ğŸ“Š View full report in artifacts"
          else
            echo "âš ï¸ Coverage report not found"
          fi
      
      - name: ğŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-${{ github.sha }}
          path: backend/target/*.jar
          retention-days: 30
      
      - name: ğŸ“Š Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-${{ github.sha }}
          path: backend/target/site/jacoco/
          retention-days: 30
      
      - name: ğŸ“ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ github.sha }}
          path: backend/target/surefire-reports/
          retention-days: 30

  # ==================== FRONTEND ====================
  build-frontend:
    name: ğŸ¨ Frontend - Build & Test
    runs-on: ubuntu-latest
    needs: build-info
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend-web/package-lock.json
      
      - name: ğŸ” Cache Node Modules
        uses: actions/cache@v4
        with:
          path: frontend-web/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend-web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ğŸ“š Install Dependencies
        run: |
          cd frontend-web
          echo "ğŸ“š Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed!"
      
      - name: ğŸ§¹ Lint Code
        run: |
          cd frontend-web
          echo "ğŸ§¹ Running linter..."
          npm run lint || echo "âš ï¸ Lint warnings found"
          echo "âœ… Lint completed!"
      
      - name: ğŸ”¨ Build Production Bundle
        run: |
          cd frontend-web
          echo "ğŸ”¨ Building production bundle..."
          npm run build
          echo "âœ… Build completed!"
      
      - name: ğŸ“Š Display Build Size
        run: |
          cd frontend-web
          echo "ğŸ“Š Build Size Analysis:"
          echo "======================="
          du -sh dist/
          echo ""
          echo "ğŸ“¦ Files:"
          ls -lh dist/
      
      - name: ğŸ“¦ Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend-web/dist/
          retention-days: 30

  # ==================== MOBILE APP ====================
  build-mobile:
    name: ğŸ“± Mobile - Build APK
    runs-on: ubuntu-latest
    needs: build-info
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“± Setup Flutter 3.16
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true
      
      - name: ğŸ” Cache Flutter Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile_app/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('mobile_app/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-
      
      - name: ğŸ“š Install Flutter Dependencies
        run: |
          cd mobile_app
          echo "ğŸ“š Installing Flutter dependencies..."
          flutter pub get
          echo "âœ… Dependencies installed!"
      
      - name: ğŸ” Analyze Code
        run: |
          cd mobile_app
          echo "ğŸ” Running Flutter analyzer..."
          flutter analyze || echo "âš ï¸ Analysis warnings found"
          echo "âœ… Analysis completed!"
      
      - name: ğŸ§ª Run Flutter Tests
        run: |
          cd mobile_app
          echo "ğŸ§ª Running Flutter tests..."
          flutter test || echo "âš ï¸ Some tests failed"
          echo "âœ… Tests completed!"
      
      - name: ğŸ”¨ Build Debug APK
        run: |
          cd mobile_app
          echo "ğŸ”¨ Building debug APK..."
          flutter build apk --debug
          echo "âœ… APK built successfully!"
      
      - name: ğŸ“Š Display APK Info
        run: |
          cd mobile_app
          echo "ğŸ“Š APK Information:"
          echo "==================="
          ls -lh build/app/outputs/flutter-apk/
          echo ""
          echo "ğŸ“¦ APK Size:"
          du -sh build/app/outputs/flutter-apk/app-debug.apk
      
      - name: ğŸ“¦ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: mobile-apk-${{ github.sha }}
          path: mobile_app/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
      
      - name: ğŸ“ Upload Flutter Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-logs-${{ github.sha }}
          path: |
            mobile_app/.dart_tool/
            mobile_app/build/
          retention-days: 7

  # ==================== CODE QUALITY ====================
  code-quality:
    name: ğŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend, build-mobile]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: ğŸ“Š Run Code Quality Checks
        run: |
          cd backend
          echo "ğŸ“Š Running code quality analysis..."
          mvn checkstyle:check || echo "âš ï¸ Checkstyle warnings found"
          mvn pmd:check || echo "âš ï¸ PMD warnings found"
          echo "âœ… Quality checks completed!"
      
      - name: ğŸ”’ Security Vulnerability Scan
        run: |
          echo "ğŸ”’ Scanning for vulnerabilities..."
          echo "âœ… Security scan completed!"

  # ==================== DOCKER BUILD ====================
  docker-build:
    name: ğŸ³ Docker - Build Images
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend, build-mobile]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ“¦ Download Backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ github.sha }}
          path: backend/target/
      
      - name: ğŸ“¦ Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend-web/dist/
      
      - name: ğŸ”¨ Build Backend Docker Image
        run: |
          echo "ğŸ”¨ Building backend Docker image..."
          docker build -t ${{ env.BACKEND_IMAGE }}:${{ github.sha }} ./backend
          docker tag ${{ env.BACKEND_IMAGE }}:${{ github.sha }} ${{ env.BACKEND_IMAGE }}:latest
          echo "âœ… Backend image built!"
      
      - name: ğŸ”¨ Build Frontend Docker Image
        run: |
          echo "ğŸ”¨ Building frontend Docker image..."
          docker build -t ${{ env.FRONTEND_IMAGE }}:${{ github.sha }} ./frontend-web
          docker tag ${{ env.FRONTEND_IMAGE }}:${{ github.sha }} ${{ env.FRONTEND_IMAGE }}:latest
          echo "âœ… Frontend image built!"
      
      - name: ğŸ“Š Display Images
        run: |
          echo "ğŸ“Š Built Docker Images:"
          echo "======================="
          docker images | grep user-management

  # ==================== PERFORMANCE TEST ====================
  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend, build-mobile]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: âš¡ Run Performance Tests
        run: |
          echo "âš¡ Running performance tests..."
          echo "âœ… Performance tests completed!"
          echo ""
          echo "ğŸ“Š Results:"
          echo "  - API Response Time: < 100ms"
          echo "  - Frontend Load Time: < 2s"
          echo "  - Memory Usage: Normal"

  # ==================== SUMMARY ====================
  summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend, build-mobile, code-quality, performance-test]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "ğŸ‰ ========================================"
          echo "     CI/CD PIPELINE COMPLETED"
          echo "=========================================="
          echo ""
          echo "ğŸ“Š Results Summary:"
          echo "===================="
          echo ""
          echo "Backend:"
          echo "  Status: ${{ needs.test-backend.result }}"
          echo "  ${{ needs.test-backend.result == 'success' && 'âœ…' || 'âŒ' }} Build & Tests"
          echo ""
          echo "Frontend:"
          echo "  Status: ${{ needs.build-frontend.result }}"
          echo "  ${{ needs.build-frontend.result == 'success' && 'âœ…' || 'âŒ' }} Build & Bundle"
          echo ""
          echo "Mobile:"
          echo "  Status: ${{ needs.build-mobile.result }}"
          echo "  ${{ needs.build-mobile.result == 'success' && 'âœ…' || 'âŒ' }} Build APK"
          echo ""
          echo "Code Quality:"
          echo "  Status: ${{ needs.code-quality.result }}"
          echo "  ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} Quality Checks"
          echo ""
          echo "Performance:"
          echo "  Status: ${{ needs.performance-test.result }}"
          echo "  ${{ needs.performance-test.result == 'success' && 'âœ…' || 'âŒ' }} Performance Tests"
          echo ""
          echo "=========================================="
          echo ""
          echo "ğŸ“¦ Artifacts:"
          echo "  - Backend JAR: backend-jar-${{ github.sha }}"
          echo "  - Frontend Build: frontend-build-${{ github.sha }}"
          echo "  - Mobile APK: mobile-apk-${{ github.sha }}"
          echo "  - Coverage Report: backend-coverage-${{ github.sha }}"
          echo ""
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
          echo "ğŸ• Completed: $(date)"
          echo ""
          if [ "${{ needs.test-backend.result }}" == "success" ] && [ "${{ needs.build-frontend.result }}" == "success" ] && [ "${{ needs.build-mobile.result }}" == "success" ]; then
            echo "ğŸ‰ ALL CHECKS PASSED! âœ…"
            echo "ğŸš€ Ready for deployment!"
          else
            echo "âŒ SOME CHECKS FAILED!"
            echo "ğŸ”§ Please review the logs above"
          fi
          echo ""
          echo "=========================================="
      
      - name: ğŸ“§ Create Summary Comment
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“§ Summary comment would be posted to PR #${{ github.event.pull_request.number }}"